<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/head :: head('Admin ë©¤ë²„ ê´€ë¦¬', '')}"></head>

<body class="hold-transition sidebar-mini">

<div class="wrapper">
    <!-- Navbar -->
    <th:block th:replace="~{layout/navbar :: navbar(${adminMember}, '')}"/>

    <!-- Sidebar -->
    <th:block th:replace="~{layout/sidebar :: sidebar(${adminMember}, '/team_management', '2')}"/>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Page Header -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col-sm-6">
                        <h1>Admin ë©¤ë²„ ê´€ë¦¬</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">í™ˆ</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="content">
            <div class="row">
                <!-- Left Side: Member List -->
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title">Admin ë©¤ë²„ ëª©ë¡</h3>
                            <div class="ml-auto d-flex align-items-center">
                                <button class="btn btn-success btn-sm mr-2" onclick="openAddMemberModal()">ë©¤ë²„ ì¶”ê°€</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table id="memberTable" class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>ì´ë¦„</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>Role</th>
                                    <th>ë¶€ì„œ</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                                </thead>
                                <tbody th:if="${teams != null and not #lists.isEmpty(teams)}">
                                <tr th:each="member, iter : ${teams}" th:id="'memberRow-' + ${member.seq}">
                                    <td th:text="${member.name}"></td>
                                    <td th:text="${member.email}"></td>
                                    <td th:text="${member.role}"></td>
                                    <td th:text="${member.depart}"></td>
                                    <td class="text-center">
                                        <button class="btn btn-warning btn-sm" th:onclick="editMember([[${member.seq}]])">ìˆ˜ì •</button>
                                        <button class="btn btn-danger btn-sm" th:onclick="deleteMember([[${member.seq}]])">ì‚­ì œ</button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="float-right d-none d-sm-block">
            <b>Version</b> 3.1.0
        </div>
        <strong>Copyright &copy; 2014-2024 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
    </footer>
</div>

<div class="modal" id="memberModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">ë©¤ë²„ ì¶”ê°€</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="memberSeq">
                <label>ì´ë¦„</label>
                <input type="text" id="memberName" class="form-control">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="memberEmail" class="form-control">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="memberPassword" class="form-control">
                <label>Role</label>
                <select id="memberRole" class="form-control">
                    <option value="superadmin">SuperAdmin</option>
                    <option value="user">User</option>
                </select>
                <label>ë¶€ì„œ</label>
                <select id="memberDepart" class="form-control">
                    <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="depart : ${departs}" th:value="${depart.departName}" th:text="${depart.departName}"></option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveMemberBtn" onclick="saveMember()">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{layout/scripts :: scripts_tables('', '')}"/>
<script src="/custom/my-script.js"></script>

<script>
    function loadMembers() {
        $.get("/members", function(data) {
            let tableBody = "";
            if (data.content && data.content.length > 0) {
                data.content.forEach((member) => {
                    tableBody += `<tr>
                        <td>${member.name}</td>
                        <td>${member.email}</td>
                        <td>${member.role}</td>
                        <td>${member.depart || "-"}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm" onclick="editMember(${member.seq})">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMember(${member.seq})">ì‚­ì œ</button>
                        </td>
                    </tr>`;
                });
            } else {
                tableBody = `<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            }
            $("#memberTable tbody").html(tableBody);
        });
    }

    $(document).ready(function() {
        $('#memberTable').DataTable({
            "processing": true,
            "serverSide": true,
            "paging": true,  // í˜ì´ì§• í™œì„±í™”
            "lengthChange": true,  // í˜ì´ì§€ í¬ê¸° ë³€ê²½ ê°€ëŠ¥
            "searching": false,  // ğŸ”¥ ê²€ìƒ‰ ê¸°ëŠ¥ ì œê±°
            "ordering": false,  // ğŸ”¥ ì •ë ¬ ê¸°ëŠ¥ ì œê±° (í•„ìš”í•˜ë©´ true)
            "info": true,  // ì •ë³´ í‘œì‹œ í™œì„±í™”
            "ajax": function(data, callback, settings) {
                let page = data.start / data.length;  // DataTablesì˜ startë¥¼ page indexë¡œ ë³€í™˜
                let size = data.length;

                $.get(`/members?page=${page}&size=${size}`, function(response) {
                    callback({
                        recordsTotal: response.totalElements,  // ì´ ë°ì´í„° ê°œìˆ˜
                        recordsFiltered: response.totalElements,  // í•„í„°ë§ëœ ë°ì´í„° ê°œìˆ˜
                        data: response.content  // ì‹¤ì œ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
                    });

                    // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ìˆ˜ë™ ì—…ë°ì´íŠ¸
                    $("#currentPage").text(response.number + 1);
                    $("#totalPages").text(response.totalPages);
                });
            },
            "columns": [
                { "data": "name" },
                { "data": "email" },
                { "data": "role" },
                { "data": "depart", "defaultContent": "-" },
                {
                    "data": "seq",
                    "render": function(data, type, row) {
                        return `
                        <div class="text-center">
                        <button class="btn btn-warning btn-sm" onclick="editMember(${data})">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMember(${data})">ì‚­ì œ</button>
                    </div>
                    `;
                    }
                }
            ]
        });
    });

    function openAddMemberModal() {
        $("#modalTitle").text("ë©¤ë²„ ì¶”ê°€");
        $("#memberSeq").val("");
        $("#memberName").val("");
        $("#memberEmail").val("");
        $("#memberPassword").val("");
        $("#memberRole").val("user");
        $("#memberDepart").val("");
        $("#memberModal").modal("show");
    }

    function editMember(seq) {
        
        $.get(`/member?seq=${seq}`, function(response) {
            $("#modalTitle").text("ë©¤ë²„ ìˆ˜ì •");
            $("#memberSeq").val(response.data.member.seq);
            $("#memberName").val(response.data.member.name);
            $("#memberEmail").val(response.data.member.email);
            $("#memberPassword").val(response.data.member.password);
            $("#memberRole").val(response.data.member.role);
            $("#memberDepart").val(response.data.member.depart);
            
            $("#memberModal").modal("show");
        });
    }

    function saveMember() {
        let seq = $("#memberSeq").val();
        let memberData = {
            seq,
            name: $("#memberName").val(),
            email: $("#memberEmail").val(),
            role: $("#memberRole").val(),
            password: $("#memberPassword").val(),
            depart: $("#memberDepart").val(),
        };

        let url = seq ? "/modify_member" : "/add_member";

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(memberData),
            success: function(response) {
                if(seq) {
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                $("#memberModal").modal("hide");
                loadMembers();
            },
            error: function(err) {
                if(seq) {
                    alert("ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                } else {
                    alert("ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                }
            }
        });
    }

    function deleteMember(seq) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        let data = {
            seq,
        };

        $.ajax({
            url: "/delete_member",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(response) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadMembers();
            },
            error: function(err) {
                alert("ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
            }
        });
    }

    function closeMemberModal() {
        $("#memberModal").modal("hide"); // Bootstrap ëª¨ë‹¬ ë‹«ê¸°
    }
</script>

</body>
</html>